<template name="lantern">
    
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <h1>Lantern</h1>
                <p>Get an instant result about one article, identifed by DOI, PMID, PMCID, or title.</p>
                <input id="ident" name="ident" type="text" value="" placeholder="DOI, PMID, PMCID, or title" class="form-control">
                <input type="submit" name="submit" class="btn btn-info btn-block" id="lanternsingle" value="Enlighten me">

                <hr>

                <p>Upload a spreadsheet (csv from excel) with any combination of the DOIs, PMIDs, PMCIDs and titles of the articles you're interested in, and we'll email you once we've checked them all.</p>

                <form action="http://dev.api.cottagelabs.com/service/lantern" method="POST" enctype="multipart/form-data" role="form">
                    <input  type="file" name="upload" id="upload" class="form-control">
                    <input class="form-control" id="email" name="email" placeholder="Your email address" type="email" value="">
                    <input type="submit" name="submit" class="btn btn-info btn-block" id="lanternmulti" value="Email me">
                </form>
            </div>
            <div class="col-md-6">
                <div class="well" style="background-color:#c9d2d4;border-color:transparent;">
                    <h3>Shed some light on your articles!</h3>                        
                    <p>Provide some article identifiers and Lantern will check what sort of license they have. Information comes from <a href="http://europepmc.org" target="_blank">Europe PubMed Central</a> and <a href="http://howopenisit.org">OpenArticleGauge</a>. See the <a href="/docs">documentation</a> for more details.</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    jQuery(document).ready(function() {        
        var lanternsingle = function() {
            var ident = $('#ident').val();
            var tp = 'doi';
            if ( ident.toLowerCase().indexOf('pmc') === 0 ) {
                // could actually fail to find PMCIDs that are not prefixed with PMC
                // no way to identify such from PMIDs, in that case. oh well.
                tp = 'pmcid';
            } else if ( ident.replace('/ /g','').length === 8 && ident.indexOf(' ') === -1 ) {
                // may accidentally identify an 8 letter long title with no spaces
                tp = 'pmid';
            } else if ( ident.indexOf(' ') !== 0 ) {
                // could miss some titles that contain no spaces. would be a weird title though
                tp = 'title';
            }
            ident = ident.toLowerCase().replace('http','').replace('https','').replace('://','').replace('dx.doi.org/','').replace('pmc','').replace('pmid','');
            var data = {};
            data[tp] = ident;
            $.ajax({
                url: 'http://dev.api.cottagelabs.com/service/lantern',
                method: 'POST',
                data: data,
                dataType: 'JSONP',
                success: function(data) {
                    // get the redirect address
                    alert(data);
                }
            });
        }
        $('#lanternsingle').bind('click',lanternsingle);

        // http://abandon.ie/notebook/simple-file-uploads-using-jquery-ajax
        var files;
        var prep = function(e) {
          files = e.target.files;
        }
        $('input[type=file]').on('change', prep);

        var submit = function(e,data) {
            $form = $(e.target);
            var formData = $form.serialize();
            // should clean these filenames
            $.each(data.files, function(key, value) {
                formData = formData + '&filenames[]=' + value;
            });

            $.ajax({
                url: 'http://dev.api.cottagelabs.com/service/lantern',
                type: 'POST',
                data: formData,
                cache: false,
                dataType: 'json',
                success: function(data, textStatus, jqXHR) {
                    if (typeof data.error === 'undefined') {
                        console.log('SUCCESS: ' + data.success);
                    } else {
                        console.log('ERRORS: ' + data.error);
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log('ERRORS: ' + textStatus);
                },
                complete: function() {
                    // hide loading icon
                }
            });
        }
        var upload = function(e) {
            e.preventDefault();
            // could show a loading icon now...

            var data = new FormData();
            $.each(files, function(key, value) {
                data.append(key, value);
            });

            $.ajax({
                url: 'http://dev.api.cottagelabs.com/service/lantern?files=true',
                type: 'POST',
                data: data,
                cache: false,
                dataType: 'json',
                processData: false,
                contentType: false,
                success: function(data, textStatus, jqXHR) {
                    if (typeof data.error === 'undefined') {
                        submit(e, data);
                    } else {
                        console.log('ERRORS: ' + data.error);
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log('ERRORS: ' + textStatus);
                    // hide loading icon
                }
            });
        }
        $('form').on('submit', upload);

    });
    </script>
</template>
