
<template name="storymap">

<style>
#mapspace{
  overflow:hidden;
  width:100%;
  height:600px;
  margin-top:-20px;
  margin-bottom:-50px;
}
.point{
  cursor: pointer;
}
.country{
  stroke: #fff;
  stroke-width: 0.8px;
  /*cursor:pointer;*/
}
.country:hover{
  stroke: #333;
  stroke-width: 0.8px;
}
.text{
  font-size:1px;
  text-transform:capitalize;
}
div.tooltip {
  color: #222; 
  background: #fff; 
  padding: .5em; 
  text-shadow: #f5f5f5 0 1px 0;
  border-radius: 2px; 
  box-shadow: 0px 0px 2px 0px #a6a6a6; 
  opacity: 0.9; 
  position: absolute;
}
</style>

<div id="mapspace"></div>


<script>
jQuery(document).ready(function() {

  mapresponse = undefined;
  var updatemap = function(data) {
    mapresponse = data;
    $('.point').remove();
    draw(topo);
  }

  var defaultmapquery = {"query": {"match_all": {} }, "fields": ["location.geo.lat","location.geo.lon"] }
  var mapquery = function(qry) {
    qry.size = 100000,
    $.ajax({
      type: 'GET',
      url: '//api.opendatabutton.org/query/blocked?source=' + JSON.stringify(qry),
      dataType: 'JSON',
      success: updatemap
    });
  }
  mapquery(defaultmapquery);
    
  d3.select(window).on("resize", throttle);

  /*var zoom = d3.behavior.zoom()
    .scaleExtent([1, 800])
    .on("zoom", move);*/    
    
  var width = document.getElementById('mapspace').offsetWidth;
  var height = $(window).height() - 5;
    
  var topo,projection,path,svg,g;

  var tooltip = d3.select("#mapspace").append("div").attr("class", "tooltip hidden");
    
  setup(width,height);
    
  function setup(width,height) {
    projection = d3.geo.mercator()
      .translate([(width/2), (height/2)])
      .scale( width / 2 / Math.PI)
      .center([0, 0 ]);

    path = d3.geo.path().projection(projection);

    svg = d3.select("#mapspace").append("svg")
      .attr("width", width)
      .attr("height", height)
      //.call(zoom)
      .on("click", click)
      .append("g");

    g = svg.append("g");
  }
    
  d3.json("//static.cottagelabs.com/maps/world-topo.json", function(error, world) {
    var countries = topojson.feature(world, world.objects.countries).features;
    topo = countries;
    draw(topo);
  });
    
  function draw(topo) {
    var country = g.selectAll(".country").data(topo);
    country.enter().insert("path")
      .attr("class", "country")
      .attr("d", path)
      .attr("id", function(d,i) { return d.id; })
      .attr("title", function(d,i) { return d.properties.name; })
      .style("fill", '#c8c8c8');

    var offsetL = document.getElementById('mapspace').offsetLeft+20;
    var offsetT = document.getElementById('mapspace').offsetTop+10;
    country
      .on("mousemove", function(d,i) {
        var mouse = d3.mouse(svg.node()).map( function(d) { return parseInt(d); } );
        tooltip.classed("hidden", false)
         .attr("style", "left:"+(mouse[0]+offsetL)+"px;top:"+(mouse[1]+offsetT)+"px")
         .html(d.properties.name);
      })
      .on("mouseout",  function(d,i) {
        tooltip.classed("hidden", true);
      });

    //add points and repo suggestions
    if ( mapresponse ) {
      mapresponse.hits.hits.forEach(function(i){
        if ( i.fields && i.fields['location.geo.lat'] && i.fields['location.geo.lon'] ) {
          addpoint(
            i.fields['location.geo.lon'][0],
            i.fields['location.geo.lat'][0]
          );
        }
      });
    }
  }
    
  function redraw() {
    width = document.getElementById('mapspace').offsetWidth;
    height = $(window).height() - 5;
    d3.select('svg').remove();
    setup(width,height);
    draw(topo);
  }
        
  function move() {    
    var t = d3.event.translate;
    var s = d3.event.scale; 
    zscale = s;
    var h = height/4;

    t[0] = Math.min(
      (width/height)  * (s - 1), 
      Math.max( width * (1 - s), t[0] )
    );
    t[1] = Math.min(
      h * (s - 1) + h * s, 
      Math.max(height  * (1 - s) - h * s, t[1])
    );

    //zoom.translate(t);
    g.attr("transform", "translate(" + t + ")scale(" + s + ")");

    //adjust the country hover stroke width and point size based on zoom level
    d3.selectAll(".country").style("stroke-width", 1 / s);
    var sz = 1 / (s/2);
    sz > 1 ? sz = 1 : sz = sz;
    d3.selectAll(".point").attr("r", sz);
  }
    
  var throttleTimer;
  function throttle() {
    window.clearTimeout(throttleTimer);
      throttleTimer = window.setTimeout(function() {
        redraw();
      }, 200);
  }
    
  //geo translation on mouse click in map
  function click() {
    var lonlat = projection.invert(d3.mouse(this));
    console.log(lonlat);
  }
    
  //function to add points and text to the map (used in plotting capitals)
  function addpoint(lon,lat) {    
    var gpoint = g.append("g").attr("class", "gpoint");
    var x = projection([lon,lat])[0];
    var y = projection([lon,lat])[1];

    gpoint.append("svg:circle")
      .attr("cx", x)
      .attr("cy", y)
      .attr("class","point")
      .attr("r", 3)
      .style("fill", '#f04717');

  }

})
</script>


</template>